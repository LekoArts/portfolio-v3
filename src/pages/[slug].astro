---
import { getCollection, render } from 'astro:content'
import { components } from '@components/mdx'
import Base from '@layouts/base.astro'
import { filterPublished, getSeriesPosts } from '@utils/collection'
import { getReadingTime } from '@utils/reading-time'
import Container from '@components/primitives/container.astro'
import SkipNavContent from '@components/a11y/skip-nav-content.astro'
import Prose from '@components/typography/prose.astro'
import Spacer from '@components/primitives/spacer.astro'
import Box from '@components/primitives/box.astro'
import Link from '@components/primitives/link.astro'
import Text from '@components/typography/text.astro'
import { getMastodonShareLink, getBlueskyShareLink, getWritingEditLink } from '@utils/sharing'
import { SITE } from '@constants/meta'
import { TOPIC_TO_COLOR_MAP } from '@constants/content'
import { defaultDateFormat, isoDateFormat, yearDateFormat } from '@utils/date'
import Heading from '@components/typography/heading.astro'
import Seo from '@components/seo.astro'
import { article } from '@constants/json-ld'
import Tag from '@components/primitives/tag.astro'
import Toc from '@components/writing/toc.astro'
import { sidebarWrapperStyle } from './_styles/_writing.css'
import FormattedDate from '@components/primitives/formatted-date.astro'
import { normalize } from '@utils/slash'
import SeriesCallout from '@components/writing/series-callout.astro'

export async function getStaticPaths() {
	const entries = await getCollection('writing', filterPublished)

	return entries.map((entry) => {
		const slug = normalize(entry.data.slug)
		const postsInSeries = getSeriesPosts(entries, entry.data.series?.id)

		return {
			params: {
				slug,
			},
			props: {
				entry,
				slug,
				postsInSeries,
			},
		}
	})
}

const { entry, slug, postsInSeries } = Astro.props
const { data: post } = entry
const { Content, headings } = await render(entry)

const ogURL = new URL(SITE.gardenOgEdge, SITE.url)
ogURL.searchParams.set(`title`, post.title)
ogURL.searchParams.set(`lastUpdated`, defaultDateFormat(post.lastUpdated))
ogURL.searchParams.set(`topics`, post.topics.join(`,`))
const fallbackOgImage = `${ogURL.pathname}${ogURL.search}`

const timeToRead = getReadingTime(entry.body ?? '')
const isPartOfSeries = !!(post.series?.id && postsInSeries.length > 1)
const ogImage = post.image ?? fallbackOgImage
---

<Base>
	<Seo forceTitle={post.title} description={post.description} image={ogImage} slot="seo">
		<meta name="twitter:label1" value="Time To Read" />
		<meta name="twitter:data1" value={timeToRead} />
		<meta name="twitter:label2" value="Topics" />
		<meta name="twitter:data2" value={post.topics.join(`, `)} />
		<meta name="article:published_time" content={isoDateFormat(post.date)} />
		<meta name="article:modified_time" content={isoDateFormat(post.lastUpdated)} />
		<script
			type="application/ld+json"
			is:inline
			set:html={JSON.stringify(
				article({
					post: {
						title: post.title,
						description: post.description,
						date: isoDateFormat(post.date),
						lastUpdated: isoDateFormat(post.lastUpdated),
						year: yearDateFormat(post.date),
						image: ogImage,
						slug,
						type: post.type,
					},
				}),
			)}
		/>
	</Seo>
	<Container variant="proseRoot">
		<SkipNavContent>
			{
				post.type === 'tutorial' || post.type === 'note' ? (
					<>
						<Heading as="h1">{post.title}</Heading>
						<Spacer size={6} axis="vertical" />
						<Box as="hr" height="px" width="full" bg="text" opacity={0.1} border="none" />
						<Spacer size={4} axis="vertical" />
						<Box display="flex" justifyContent="space-between" flexDirection={[`column`, null, null, `row`]} gap={2}>
							<Text fontSize={{ mobile: 'sm', md: 'md' }}>
								Created: <FormattedDate date={post.date} /> â€“ Last Updated: <FormattedDate date={post.lastUpdated} />
							</Text>
							<Box gap={2} display="flex">
								{post.topics.map((topic) => (
									<Link href="/">
										<Tag colorScheme={TOPIC_TO_COLOR_MAP[topic]}>{topic}</Tag>
									</Link>
								))}
							</Box>
						</Box>
						<Spacer size={isPartOfSeries ? 4 : 10} axis="vertical" />
					</>
				) : (
					<>
						<Text
							color="textEmphasized"
							fontWeight="medium"
							textAlign="center"
							fontSize={[`md`, null, null, `lg`, `lgx`]}
						>
							{post.topics.join(', ')}
						</Text>
						<Spacer size={6} axis="vertical" />
						<Heading as="h1" textAlign="center">
							{post.title}
						</Heading>
						<Spacer size={16} axis="vertical" />
					</>
				)
			}
			{
				post.type === 'tutorial' ? (
					<Box flexDirection="row-reverse" justifyContent="flex-end" gap={20} class={sidebarWrapperStyle}>
						<Toc headings={headings} />
						<Prose as="article" style={{ flex: `1 1 100%`, minWidth: `100%` }}>
							<Content components={components} />
						</Prose>
					</Box>
				) : (
					<Prose>
						{isPartOfSeries ? (
							<>
								<SeriesCallout id={post.series!.id} currentPart={post.series!.part} postsInSeries={postsInSeries} />
								<Spacer size={8} axis="vertical" />
							</>
						) : null}
						<Content components={components} />
					</Prose>
				)
			}
			<Spacer size={12} axis="vertical" />
			<Box as="hr" height="px" width="full" bg="text" opacity={0.1} border="none" />
			<Spacer size={6} axis="vertical" />
			<Box
				display="flex"
				flexDirection={[`column`, `row`]}
				gap={5}
				justifyContent={[`flex-start`, `space-between`]}
				alignItems={[`flex-start`, `center`]}
			>
				<Box fontSize={[`md`, null, null, `lg`]} fontWeight="medium">
					{
						SITE.isPublic && (
							<>
								<Link target="_blank" href={getWritingEditLink(entry.id)}>
									Edit on GitHub
								</Link>{' '}
								-{' '}
							</>
						)
					}Share on <Link target="_blank" href={getBlueskyShareLink(`${SITE.url}${slug}`, post.title)}>Bluesky</Link> / <Link
						target="_blank"
						href={getMastodonShareLink(`${SITE.url}${slug}`, post.title)}>Mastodon</Link
					>
				</Box>
			</Box>
			{
				post.type === 'essay' && (
					<Text marginTop={6} fontSize={[`md`, null, null, `lg`]}>
						Last updated: <FormattedDate date={post.lastUpdated} />
					</Text>
				)
			}
		</SkipNavContent>
	</Container>
</Base>
